#!/bin/bash
# postinst script 
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#


function sed_append_sting {
  PATTERN=$1
  LINE=$2
  FLE=$3
  
  if [ -e $FLE ]; then
    if grep -q $PATTERN "$FLE"; then
      # Escape forward slashes
      LINE=$(echo $LINE | sed 's/\//\\\//g')
      sed -i -e "s/$PATTERN/$LINE/" $FLE
    else
      echo $LINE >> $FLE
    fi
  fi
}

case "$1" in    
  configure|reconfigure)
    # Configure LightDM
    CONF='/etc/lightdm/lightdm-kde-greeter.conf'
    if [ -e '/etc/lightdm/lightdm-gtk-greeter.conf' ]; then
      CONF='/etc/lightdm/lightdm-gtk-greeter.conf'
    fi
    
    sed_append_sting '^background\s*=.*' 'background=/usr/share/images/desktop-base/solydx-lightdmbg-flat.png' $CONF
    sed_append_sting '^theme-name\s*=.*' 'theme-name=greybird-solydx' $CONF
    sed_append_sting '^default-user-image\s*=.*' 'default-user-image=/usr/share/pixmaps/faces/user-generic.png' $CONF
    
    CONF='/etc/lightdm/lightdm.conf'
    if [ -e $CONF ]; then
	sed -i -e '/^greeter-hide-users\s*=/ c greeter-hide-users=false' $CONF
    fi
	
    # Only run this on first install
    if [ ! -z "$2" ]; then
	if [ -e /etc/skel/.bashrc ]; then       
	    sed -i -e '/xterm-color) color_prompt/ c     xterm | xterm-color) color_prompt=yes;;' /etc/skel/.bashrc
	    sed -i -e '/01;32m/ s/32m/34m/' /etc/skel/.bashrc
	fi
    fi
    
    # Move default Xfce wallpapper
    BG='/usr/share/backgrounds'
    if [ -d "$BG/xfce" ] ; then
      if [ -e "$BG/.xfce" ]; then
        rm -fr "$BG/.xfce"
      fi
      mv -f "$BG/xfce" "$BG/.xfce"
    fi
       
    /usr/lib/solydxk/system/adjust.py
    FC=$(which fc-cache)
    if [ "$FC" != "" ]; then
      fc-cache -f
    fi
    UG=$(which update-grub)
    if [ "$UG" != "" ]; then
      update-grub
    fi
    
    FLE='/etc/skel/.config/applications/defaults.list'
    if [ -e $FLE ]; then
      rm $FLE
    fi
    
    FLE='/etc/skel/.local/share/applications/defaults.list'
    if [ -e $FLE ]; then
      rm $FLE
    fi
    
    FLE='/etc/skel/.local/share/applications/softwaremanager.desktop'
    if [ -e $FLE ]; then
      rm $FLE
    fi
    
  ;;
  
  upgrade|update)
  
  ;;
  abort-upgrade|abort-remove|abort-deconfigure)

  ;;
  triggered)

  ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
  ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0


